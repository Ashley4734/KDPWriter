[variables]
NODE_ENV = 'production'
NPM_CONFIG_PRODUCTION = 'false'

[phases.setup]
nixPkgs = ['nodejs_18', 'npm-9_x']
aptPkgs = ['libnss3', 'libatk1.0-0', 'libatk-bridge2.0-0', 'libcups2', 'libgbm1', 'libasound2t64', 'libpangocairo-1.0-0', 'libxss1', 'libgtk-3-0', 'libxshmfence1', 'libglu1', 'chromium']

[phases.install] 
cmds = ['npm ci']

[phases.build]
cmds = ['npm run build']

[phases.production-build]
dependsOn = ['build']
cmds = ['npx esbuild server/production.ts --platform=node --packages=external --bundle --format=esm --outfile=dist/server.js']

[start]
cmd = 'node dist/server.js'